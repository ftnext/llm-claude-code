# LLM Claude Code Plugin Specification

## æ¦‚è¦

`llm-claude-code`ã¯ã€[simonw/llm](https://github.com/simonw/llm)ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ã€Claude Code SDKã‚’ä½¿ç”¨ã—ã¦Claude Codeã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®å®Ÿè£…ã§ã™ã€‚

## åŸºæœ¬è¨­è¨ˆ

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å
- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å: `llm-claude-code`
- ãƒ¢ãƒ‡ãƒ«ID: `claude-code`
- ã‚¨ã‚¤ãƒªã‚¢ã‚¹: `cc`

### å‰ææ¡ä»¶
- Claude Code CLI: `npm install -g @anthropic-ai/claude-code`
- Node.js: Claude Code CLIå®Ÿè¡Œã«å¿…è¦
- Anthropic APIã‚­ãƒ¼ãŒè¨­å®šæ¸ˆã¿ï¼ˆç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Claude Codeã®è¨­å®šï¼‰
- Python 3.10ä»¥ä¸Š

## æ©Ÿèƒ½ä»•æ§˜

### 1. åŸºæœ¬æ©Ÿèƒ½
```bash
# åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•
llm -m claude-code "Pythonã§ãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã‚’æ›¸ã„ã¦"

# ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨
llm -m cc "hello worldã‚’å‡ºåŠ›ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ"
```

### 2. èªè¨¼
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å´ã§ã®èªè¨¼è¨­å®šã¯ä¸è¦
- Claude Code SDKãŒæ—¢å­˜ã®èªè¨¼æƒ…å ±ï¼ˆç’°å¢ƒå¤‰æ•°`ANTHROPIC_API_KEY`ãªã©ï¼‰ã‚’ä½¿ç”¨
- Claude Code CLIã®èªè¨¼è¨­å®šã‚’ç¶™æ‰¿

### 3. ãƒ„ãƒ¼ãƒ«ä½¿ç”¨
- åˆæœŸå®Ÿè£…ã§ã¯ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã¯ç„¡åŠ¹ï¼ˆ`allowed_tools=[]`ï¼‰
- å°†æ¥çš„ãªæ‹¡å¼µã®ãŸã‚ã€å†…éƒ¨çš„ã«ã¯ãƒ„ãƒ¼ãƒ«çµæœã®å‡¦ç†æ©Ÿæ§‹ã‚’å®Ÿè£…

### 4. ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- åˆæœŸå®Ÿè£…ã§ã¯LLMã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆ`-o`ï¼‰ã¯æä¾›ã—ãªã„
- Claude Code SDKã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨
- `max_turns=1`ã§å˜ç™ºå¿œç­”ã«åˆ¶é™
- `allowed_tools=[]`ã§ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã‚’ç„¡åŠ¹åŒ–

### 5. å‡ºåŠ›å½¢å¼

#### 5.1 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—
Claude Code SDKã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ï¼š
- `Message`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰`content`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
- `TextBlock`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`text`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
- ãƒªã‚¹ãƒˆå½¢å¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆè¤‡æ•°TextBlockï¼‰ã«å¯¾å¿œ

#### 5.2 è¡¨ç¤ºå½¢å¼
```
# ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ï¼‰
ãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

# ãƒ„ãƒ¼ãƒ«ä½¿ç”¨çµæœï¼ˆè‰²ä»˜ãè¡¨ç¤ºï¼‰
[Tool: Read] ãƒ•ã‚¡ã‚¤ãƒ« 'example.py' ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ
[Tool: Write] ãƒ•ã‚¡ã‚¤ãƒ« 'fibonacci.py' ã‚’ä½œæˆã—ã¾ã—ãŸ

# æœ€çµ‚çµæœ
âœ“ æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ˆå®Ÿè¡Œæ™‚é–“: 2.3ç§’ï¼‰
```

#### 5.3 è‰²åˆ†ã‘ä»•æ§˜
- ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
- ãƒ„ãƒ¼ãƒ«ä½¿ç”¨çµæœ: é’è‰²ï¼ˆANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ä½¿ç”¨ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: èµ¤è‰²
- ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ç°è‰²

### 6. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- Claude Code SDKã®éåŒæœŸã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚’LLMã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ã¨ã—ã¦å®Ÿè£…
- `can_stream = True`ã‚’è¨­å®š
- `anyio`ã‚’ä½¿ç”¨ã—ãŸéåŒæœŸâ†’åŒæœŸå¤‰æ›
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

### 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- `ProcessError`: SDKå®Ÿè¡Œã‚¨ãƒ©ãƒ¼
- é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
- `response.response_json`ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ã¨å®Ÿè¡Œæ™‚é–“ã‚’è¨˜éŒ²

## å®Ÿè£…æ§‹é€ 

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
llm-claude-code/
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ llm_claude_code.py
â”œâ”€â”€ README.md
â”œâ”€â”€ LICENSE
â””â”€â”€ tests/
    â””â”€â”€ test_claude_code.py
```

### ä¸»è¦ã‚¯ãƒ©ã‚¹ã¨å®Ÿè£…

```python
from claude_code_sdk import query, ClaudeCodeOptions
import anyio

class ClaudeCode(llm.Model):
    model_id = "claude-code"
    aliases = ("cc",)
    can_stream = True
    
    def execute(self, prompt, stream, response, conversation=None):
        # anyioã‚’ä½¿ç”¨ã—ã¦Claude Code SDKã¨é€£æº
        if stream:
            return self._sync_stream_execute(prompt, response, start_time)
        else:
            result = anyio.run(self._execute_single, prompt)
            return [result]

@llm.hookimpl
def register_models(register):
    register(ClaudeCode())
```

## æŠ€è¡“çš„ãªè€ƒæ…®äº‹é …

### 1. éåŒæœŸå‡¦ç†ã¨åŒæœŸå¤‰æ›
- Claude Code SDKã¯éåŒæœŸAPIã‚’æä¾›
- LLMãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯åŒæœŸçš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æœŸå¾…
- `anyio.run`ã‚’ä½¿ç”¨ã—ã¦éåŒæœŸâ†’åŒæœŸå¤‰æ›ã‚’å®Ÿè£…
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ™‚ã¯`_collect_async_generator`ã§åé›†å¾Œã«åŒæœŸã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦è¿”å´

### 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
- `TextBlock`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰`text`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
- ãƒªã‚¹ãƒˆå½¢å¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆè¤‡æ•°TextBlockï¼‰ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
- æ–‡å­—åˆ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸¡æ–¹ã«å¯¾å¿œ

### 3. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²
- `@llm.hookimpl`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨
- `register_models(register)`é–¢æ•°ã§ãƒ¢ãƒ‡ãƒ«ã‚’ç™»éŒ²
- `llm.default_model`ã¯ä½¿ç”¨ä¸å¯ã®ãŸã‚ç‹¬è‡ªã®ç™»éŒ²æ©Ÿæ§‹ã‚’å®Ÿè£…

### 4. ãƒ­ã‚°è¨˜éŒ²
- LLMã®ãƒ­ã‚°æ©Ÿèƒ½ã‚’æ´»ç”¨
- `response.response_json`ã«è¿½åŠ æƒ…å ±ã‚’è¨˜éŒ²
  - å®Ÿè¡Œæ™‚é–“
  - ãƒ¢ãƒ‡ãƒ«ID
  - ã‚¨ãƒ©ãƒ¼æƒ…å ±

## å°†æ¥ã®æ‹¡å¼µ

### Phase 2ï¼ˆãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã®æœ‰åŠ¹åŒ–ï¼‰
- ç‰¹å®šã®ãƒ„ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
- `-o tools read,write`ã®ã‚ˆã†ãªå½¢å¼

### Phase 3ï¼ˆé«˜åº¦ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- `system_prompt`ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- `max_turns`ã®è¨­å®š
- `cwd`ï¼ˆä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ã®æŒ‡å®š

### Phase 4ï¼ˆä¼šè©±ã®ç¶™ç¶šï¼‰
- LLMã®ä¼šè©±æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- Claude Codeã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ä¿æŒ

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### å˜ä½“ãƒ†ã‚¹ãƒˆ
- ãƒ¢ãƒ‡ãƒ«ã®ç™»éŒ²ç¢ºèª
- ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å‹•ä½œç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
- ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã®ãƒ†ã‚¹ãƒˆ

### çµ±åˆãƒ†ã‚¹ãƒˆ
- Claude Code SDKã®`query`é–¢æ•°ã‚’ãƒ¢ãƒƒã‚¯åŒ–
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‹•ä½œã®ç¢ºèª
- TextBlockã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‡¦ç†ç¢ºèª
- éåŒæœŸâ†’åŒæœŸå¤‰æ›ã®å‹•ä½œç¢ºèª

## å®Ÿè£…å®Œäº†çŠ¶æ³

### âœ… å®Œäº†ã—ãŸæ©Ÿèƒ½
- Claude Code SDKã¨ã®çµ±åˆï¼ˆ`claude-code-sdk` v0.0.11ï¼‰
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²æ©Ÿæ§‹
- åŒæœŸãƒ»éåŒæœŸä¸¡æ–¹ã®å®Ÿè¡Œæ–¹å¼
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ
- TextBlockãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
- ã‚«ãƒ©ãƒ¼å‡ºåŠ›ï¼ˆãƒ„ãƒ¼ãƒ«ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ğŸ“‹ æŠ€è¡“ä»•æ§˜
- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: `claude-code-sdk>=0.0.11`
- éåŒæœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª: `anyio>=3.0.0`
- Pythonè¦ä»¶: >=3.10
- ãƒ†ã‚¹ãƒˆ: pytest + pytest-asyncio
- ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿: ruff

## é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
uv run pytest
```

### ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
```bash
uv run ruff format
```

### ãƒªãƒ³ãƒˆå®Ÿè¡Œï¼ˆè‡ªå‹•ä¿®æ­£ä»˜ãï¼‰
```bash
uv run ruff check --fix --extend-select I
```

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
uv run llm -m claude-code "ã“ã‚“ã«ã¡ã¯"
```

### é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
uv sync --extra test --extra dev
```

## å‚è€ƒè³‡æ–™
- [LLM Plugin Development Guide](https://llm.datasette.io/en/stable/plugins/tutorial-model-plugin.html)
- [Claude Code SDK Documentation](https://docs.anthropic.com/en/docs/claude-code/sdk)
- [Claude Code SDK PyPI](https://pypi.org/project/claude-code-sdk/)